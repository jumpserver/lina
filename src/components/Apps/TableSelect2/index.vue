<template>
  <div class="user-select-formatter">
    <Select2
      ref="select2"
      v-model="select2Config.value"
      v-bind="select2Config"
      @input="onInputChange"
      v-on="$listeners"
      @focus.stop="handleFocus"
    />
    <UserSelectDialog
      v-if="dialogVisible"
      :value="value"
      :visible.sync="dialogVisible"
      v-bind="$attrs"
      @cancel="handleCancel"
      @confirm="handleConfirm"
      v-on="$listeners"
    />
  </div>
</template>

<script>
import Select2 from '../../Form/FormFields/Select2.vue'
import UserSelectDialog from './dialog.vue'
import { b } from 'css-color-function/lib/adjusters'

export default {
  components: { UserSelectDialog, Select2 },
  props: {
    url: {
      type: String,
      default: '/api/v1/users/users/'
    },
    value: {
      type: Array,
      default: () => []
    }
  },
  data() {
    const iValue = []
    for (const item of this.value) {
      if (typeof item === 'object') {
        iValue.push(item.id)
      } else {
        iValue.push(item)
      }
    }
    return {
      dialogVisible: false,
      initialValue: _.cloneDeep(iValue),
      select2Config: {
        value: iValue,
        multiple: true,
        clearable: true,
        ajax: {
          url: this.url,
          transformOption: (item) => {
            return { label: item.name + '(' + item.username + ')', value: item.id }
          }
        }
      }
    }
  },
  methods: {
    b,
    handleFocus() {
      this.$refs.select2.selectRef.blur()
      this.dialogVisible = true
    },
    handleConfirm(valueSelected, rowsAdd) {
      if (valueSelected === undefined) {
        return
      }
      this.$refs.select2.iValue = valueSelected
      this.addRowsToSelect(rowsAdd)
      this.onInputChange(valueSelected)
      this.dialogVisible = false
    },
    handleCancel() {
      this.dialogVisible = false
    },
    onInputChange(val) {
      this.$emit('change', val)
    },
    addToSelect(options, row) {
      const selectOptionsHas = options.find(item => item.value === row.id)
      if (selectOptionsHas === undefined) {
        const option = {
          label: `${row.name}(${row.username})`,
          value: row.id
        }
        options.push(option)
      }
    },
    addRowsToSelect(rows) {
      const outSelectOptions = this.$refs.select2.options
      for (const row of rows) {
        this.addToSelect(outSelectOptions, row)
      }
    }
  }
}
</script>

<style lang="scss" scoped>
</style>
